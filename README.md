# Агрегатор новостей.

### Приложение для автоматического сбора, обработки и представления новостных материалов с различных интернет-ресурсов.

## Архитектура

Консольное монолитное Java приложение, построенное на принципе IoC и DI под управлением системы Spring.
Управление зависимостями и сборка производится системой Maven.
Подключение большинства необходимых библиотек осуществляется через включение в проект деклараций Spring Boot.
Конфигурирование компонентов приложения (например, соединения с базой данных) осуществляется через конфигурационный
файл application.yml, который обрабатывает Spring.
Таким образом, управление базовой структурой и конфигурацией приложения максимально упрощено и централизовано.

Структурно приложение можно разделить на следующие функциональные блоки:

- блок работы с базами данных
- блок бизнес-логики
- блок пользовательского ввода-вывода

### Блок работы с базами данных

Доступ к данным в приложении осуществляется через библиотеку Hibernate, которая реализует спецификации JPA.
Hibernate подключается к проекту автоматически при подключении модуля spring-boot-starter-data-jpa в проект Maven.
Конфигурация доступа к базе производится в файле application.yml в секциях datasource и jpa.

В качестве СУБД выбрана свободная система PostgreSQL.
Все, что необходимо для организации доступа, это указать 3 параметра в секции datasource

- url - адрес базы данных, включая ее имя (имя схемы можно опустить, будет использоваться схема по умолчанию - public)
- username: имя пользователя базы данных
- password: пароль пользователя базы данных
  Пароль хранится в открытом виде. Такое решение не подходит для промышленной эксплуатации, но подходит для тестовых
  целей.

Для настройки Hibernate необходимо указать чуть больше параметров.
Ключевые из них:

- properties.hibernate.dialect - указание на диалект SQL для Hibernate
- database: postgresql - указание на тип базы данных
- hibernate.ddl-auto - указание на тип работы с данными
- hibernate.naming.physical-strategy - стратегия именования таблиц

Hibernate осуществляет связь кода и таблиц в базе данных посредством технологии ORM -
объектно-реляционное отображение (представление, маппинг).
С каждой таблицей будет связано как минимум 2 конструкции в коде - объект сущности, представляющий собой отображение
записи в таблице на объект Java и интерфейс репозитория, который предоставит методы для доступа к данным в этой таблице.
Объекты сущностей хранятся в пакете 'model', репозитории в пакете 'repository'.
Объекты сущностей это полноценные Java классы, которые аннотированы специальным образом.
Интерфейсы репозиториев не имеют прямой реализации в исходном коде, реализация будет создана динамически во время
компиляции приложения.

### Блок бизнес-логики

В широком смысле бизнес-логика приложения представлена следующими правилами:

- получение данных из источников
- разбор полученных данных
- сохранение данных
- получение сохраненных данных
- статистический анализ данных
- отображение данных
- экспорт данных

В рамках системы Spring объектами, которые реализуют бизнес-логику приложения, выступают особые компоненты - сервисы.
Сервис представляет собой обычный класс Java, маркированный аннотацией @Service, для явного указания его предназначения.
Сервисы размещены в пакете 'service'.
Для обеспечения слабого связывания сервисы реализованы в виде интерфейса и непосредственно реализации.

Как правило, сервисы являются именно теми объектами, которые напрямую взаимодействуют с репозиториями.
Все остальные подсистемы не должны иметь прямого доступа к данным; все операции осуществляются посредством сервисов.
Это ограничение может быть нарушено утилитными классами при условии того, что они не передают объекты данных дальше
самих себя.

#### Сервис NewsParser

Осуществляет реализацию следующего функционала:

- получение данных из источников
- разбор полученных данных
- сохранение данных

Наличие сразу нескольких зон ответственности в данном сервисе обусловлено тем, что операции получения данных из
источников и их разбор реализованы сторонней библиотекой JSoup, которая эффективно производит операции получения и
разбора данных в форматах HTML и XML.
Сервис также взаимодействует со всеми основными репозиториями, как так необходимо производить операции загрузки
параметров для работы библиотеки Jsoup, а также производить операции сохранения в базу данных подготовленных
структурированных данных.

#### Сервис FilterService

Осуществляет реализацию следующего функционала:

- получение сохраненных данных по заданным критериям

Критерии фильтрации описаны в объекте фильтра FilterService::NewsFilter.
Реализация сервиса обрабатывает эти критерии и осуществляет целевой запрос в базу данных в таблицу 'news', которая
содержит все полученные новости, используя специально подготовленные методы репозитория NewsRepository.

Фильтрация доступна по следующим критериям:

- по дате новости
- по источнику новости
- по категории новости
- по ключевым словам

Отфильтрованный список новостей может быть передан вспомогательным подсистемам для выполнения операций отображения или
экспорта.

#### Сервис StatisticsService

Осуществляет реализацию следующего функционала:

- статистический анализ данных

Реализация сервиса работает репозиторием NewsRepository и также полагается на методы выборки данных которые
предоставляет репозиторий.

Сервис производит сбор следующих статистических данных:

- количество новостей по категориям
- рейтинг популярности новостей
- динамика частоты ключевых слов за период

Сервис не визуализирует полученные данные, а отдает их вспомогательным подсистемам.

### Блок пользовательского ввода-вывода

Реализация в виде консольного приложения накладывает ряд ограничений на способы ввода информации пользователем,
а так же на то, каким образом система представит вывод результатов.
Любое интерактивное приложение предполагает в своей основе наличие условно бесконечного цикла "ожидание ввода - вывод",
где каждая итерация представляет собой законченное действие, которое приводит либо к переходу системы в новое состояние,
либо сохранение текущего. Пока работает этот главный цикл - работает и приложение.

Приглашение системы к работе организовано в виде нумерованных текстовых списков - меню. Каждый пункт меню может быть
реализован в виде команды или переключателя.
Команда выполняет заданное действие и не меняет состояние ожидания ввода, команда не приводит к переходу на новое меню.
Переключатель может выполнить действие, если это необходимо, но главное его предназначение - переключение контекста
ввода на новый уровень меню.
Само меню выступает не только контейнером для команд и переключателей, но и может выступать в роли объекта,
производящего отображение текстовой информации на экране.

Таким образом, подсистема ввода-вывода построена на основе простых абстракций - меню, команда и переключатель,
заключенных в главный цикл приложения.

#### Главный цикл

Главный цикл системы реализован в классе MenuRunner. Его основное предназначение производить ожидание и обработку
пользовательского ввода. Ожидание ввода осуществляется посредством стандартного объекта Scanner. Обработка заключается
в анализе идентификатора команды, введенного пользователем, поиска команды, ее исполнения и переключения контекста ввода
для следующей итерации. Кроме этих операций MenuRunner позволяет объекту текущего меню отобразить необходимую
информацию, а также обрабатывает исключения, которые могут произойти в процессе работы команд.

#### Меню

Меню системы может быть сформировано статически и динамически.
Статическое описание меню применяется для формирования меню, наполнение которого не зависит от наполненности системы
данными, например - главное меню.
Динамические меню используются для отображения и обработки данных, набор которых заранее не известен.

Для декларации статических меню используются следующие сущности:

- перечисление StaticMenu - для объявления заголовка меню и представления идентификатора, посредством которого
  происходит связь переключателей с конкретным меню
- перечисление StaticMenuItem - для объявления названия элементы меню и представления идентификатора, посредством
  которого происходит связь элемента меню и меню
- классов меню, расположенных в пакете menu.main, которые производят наполнение элементов меню и реализуют, при
  необходимости, операции вывода дополнительной информации

Реализация динамических меню представлена следующими классами:

- DynamicNewsItemMenu - реализация меню для чтения новости
- NewsDynamicMenuFactory - фабрика динамических меню для коллекции новостей

Меню выполняет две задачи:

- вывод на экран элементов меню в заданном порядке
- реализация вывода объемной текстовой информации перед выводом списка доступных команд
  Именно таким образом реализован режим чтения новости

Базовая реализация компонентов меню представлена в пакете common.menu.impl

#### Регистратор меню

Специальный класс, который проводит сбор всех компонентов меню и элементов меню и осуществляет их регистрацию в реестре.
Этот класс единственный компонент в системе, который зависит от конкретных реализаций меню. Он осуществляет позднее
связывание реестра и элементов меню, так как раннее связывание невозможно из-за наличия перекрестных ссылок между
реестром и элементами меню.
Запуск связывания осуществляется в классе приложения перед стартом главного цикла обработки.

#### Реестр меню

Доступ к меню и элементам меню осуществляется через специальный компонент реестра, представленный интерфейсом
MenuRegistry.
Его основная задача - производить поиск меню и элементов меню по соответствующим идентификаторам, а также производить
регистрационные действия с динамическими меню. Реестр выступает в роли специализированного контейнера для
хранения экземпляров классов меню и их элементов.
Главный цикл приложения работает с реестром на каждой итерации, фабрика динамических меню регистрирует созданные объекты
в реестре, базовая реализация статических меню осуществляет те же действия в реестре.
Использование реестра значительно уменьшает связь реализаций классов.

### Экспорт данных

Приложение осуществляет вывод данных в формате XLSX, который поддерживается большинством программ для работы
с электронными таблицами. Экспорт производится посредством обращения к сторонней библиотеке Apache POI.

Концептуально процедура экспорта разбита на следующие шаги:

- создание объекта Workbook, представляющего абстракцию книги в терминологии электронных таблиц
- создание объекта страницы Sheet
- создание строки заголовка (Row) и заполнение ячеек (Cell) названиями столбцов
- обход списка с объектами новостей, подлежащих экспорту, создание строк и заполнение ячеек данными
- сохранение данных во внешний файл
- вывод на экран информации о созданном файле

Реализация экспорта представлена в классе NewsXlsxExporter.
Для активации процедуры экспорта в меню просмотра списка новостей и меню просмотра отдельной новости добавляется
динамическая команда экспорта, реализованная в классе ExportNewsToXlsxCommand.
Эта команда инициирует процедуру экспорта посредством обращения к объекту NewsXlsxExporter, производит обработку
ошибок и выводит информацию об итоговом файле.
